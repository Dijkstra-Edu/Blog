---
import { Image } from "astro:assets";
import type { CollectionEntry } from "astro:content";
import Divider from "@/components/bases/divider.astro";
import { render } from "astro:content";
import { getDateDistance } from "@/lib/utils/date";
import { collections } from "@/content/config";

type Props = {
  entry: CollectionEntry<"blog">;
  isFirst?: boolean;
  isLast?: boolean;
};

const { entry, isFirst, isLast } = Astro.props;

// Attempt to render content frontmatter safely
let remarkPluginFrontmatter: any = {};
try {
  ({ remarkPluginFrontmatter } = await render(entry));
} catch (err) {
  console.error("Render failed for blog entry:", entry.id, err);
}

// Default date fallback
const displayDate = remarkPluginFrontmatter?.lastModified ?? entry.data.date ?? "Unknown date";
---
<article
  class:list={[
    "group py-2 flex items-stretch gap-2 relative isolate",
    isFirst ? "pt-0" : "pt-2",
    isLast ? "border-b-0 pb-0" : "border-b border-base-300",
  ]}
>
  <a href={`/blog/${entry.id}`} class="flex flex-1 gap-4">
    {entry.data.image && (
      <div class="overflow-hidden w-[120px] h-[80px] md:w-[120px] md:h-full shrink-0">
        <Image
          src={entry.data.image}
          alt={entry.data.title}
          layout="constrained"
          widths={[120, 320]}
          class="object-cover rounded"
        />
      </div>
    )}

    <div class="flex flex-col flex-1">
      <h3 class="text-lg font-medium mb-1 group-hover:underline">
        {entry.data.title}
      </h3>
      <p class="text-sm text-base-content/80 line-clamp-2">
        {entry.data.description}
      </p>

      <div class="flex items-center gap-2 mt-1 text-xs text-base-content/80">
        <span>{getDateDistance(displayDate)}</span>
        <Divider />
        <span>{entry.data.tags?.join(", ")}</span>
      </div>
    </div>
  </a>
</article>
